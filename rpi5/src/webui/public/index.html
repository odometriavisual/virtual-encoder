<html lang="pt">
<head>
	<style>
		.wrapper {
			display: grid;
			grid-template-columns: 640px 144px;
			grid-template-rows: 480px 48px;
			grid-gap: 4px;
			font-family: sans;
		}

		.wrapper > .video-frame {
			width: 640px;
			height: 480px;
			grid-area: 1 / 1 / 2 / 2;
		}

		.wrapper > .h-group {
			grid-row: 2;
			grid-column: span 2;

			display: grid;
			grid-template-columns: repeat(13, 1fr);
			grid-auto-flow: row;
			grid-gap: 4px;
		}

		.wrapper > .v-group {
			grid-column: 2;

			display: grid;
			grid-template-rows: .5fr repeat(5, 1fr);
			grid-auto-flow: column;
			grid-gap: 4px;

			user-select: none;
		}

		.h-group > .spacer {
			grid-column: span 1;
		}

		button {
			grid-column: span 2;
		}

		.v-group > div {
			display: flex;
			justify-content: center;
			align-items: center;
			text-align: center;
		}

		div.rpi5 {
			grid-row: span 2;
		}

		.ok {
			background-color: #009933;
			color: white;

			border: 1px solid #114221;
			border-radius: 4px;
		}

		.ok.warn {
			background-color: #d3cc2a;
			color: #353150;

			border: 1px solid #39391c;
			border-radius: 4px;
		}

		.err {
			background-color: #cc0000;
			color: white;

			border: 1px solid #aa1010;
			border-radius: 4px;
		}
	</style>
	<title>Virtual Encoder</title>
</head>
<body>
<script>
	window.onload = () => {
		const btns = {
			calibracao: document.querySelector('button.calibracao'),
			iniciar_disparo: document.querySelector('button.iniciar-disparo'),
			parar_disparo: document.querySelector('button.parar-disparo'),
			iniciar_download: document.querySelector('button.iniciar-download'),
			modo_tempo: document.querySelector('button.modo-tempo'),
			modo_autonomo: document.querySelector('button.modo-autonomo'),
			modo_estimativa: document.querySelector('button.modo-estimativa'),
		};

		const status_watcher = {
			rpi5: document.querySelector('.status.rpi5'),
			rpi0: document.querySelector('.status.rpi0'),
			camera: document.querySelector('.status.camera'),
			imu: document.querySelector('.status.imu'),
		};

		async function next_estado(event) {
			event.target.disabled = true;

			const method = 'POST';
			await fetch('/next_estado', { method });
		}

		async function next_modo(event, modo) {
			event.target.disabled = true;

			const method = 'POST';
			await fetch(`/next_modo/${modo}`, { method });
		}

		btns.calibracao.addEventListener('click', next_estado);
		btns.iniciar_disparo.addEventListener('click', next_estado);
		btns.parar_disparo.addEventListener('click', next_estado);

		btns.iniciar_download.addEventListener('click', event => next_modo(event, 'Download'));
		btns.modo_autonomo.addEventListener('click', event => next_modo(event, 'Autonomo'));
		btns.modo_tempo.addEventListener('click', event => next_modo(event, 'Tempo'));

		function update_classname(div, stat) {
			if (stat) div.className = div.className.replace('err', 'ok')
			else div.className = div.className.replace('ok', 'err')
		}

		function update_status(status) {
			update_classname(status_watcher.rpi5, status.rpi5);
			if (status.estado === 'Calibrando...' || status.modo === 'Download') {
				status_watcher.rpi5.classList.add('warn');
			}
			else {
				status_watcher.rpi5.classList.remove('warn');
			}

			update_classname(status_watcher.rpi0, status.rpi0);
			update_classname(status_watcher.camera, status.camera);
			update_classname(status_watcher.imu, status.imu);

			status_watcher.rpi5.innerText = `RPi 5\n\n\nModo ${status.modo}\n\n\nEstado ${status.estado}`

			if (status.modo === 'Tempo') {
				btns.iniciar_download.disabled = false;
				btns.modo_tempo.disabled = true;
				btns.modo_autonomo.disabled = false;

				btns.calibracao.disabled = status.estado !== 'Set';
				btns.iniciar_disparo.disabled = status.estado !== 'Ready';
				btns.parar_disparo.disabled = status.estado !== 'Disparo';
			}
			else if (status.modo === 'Autonomo') {
				btns.iniciar_download.disabled = false;
				btns.modo_tempo.disabled = false;
				btns.modo_autonomo.disabled = true;
			}
			else if (status.modo === 'Download') {
				btns.iniciar_download.disabled = true;
				btns.modo_tempo.disabled = true;
				btns.modo_autonomo.disabled = true;
			}
		}

		async function fetch_status() {
			const headers = {
				'Accept': 'application/json',
				'Keep-Alive': 'timeout=5, max=-1'
			};
			const method = 'GET';
			const keepalive = true;
			const res = await fetch('/status', {headers, keepalive, method});
			const status = await res.json();

			update_status(status)
		}
		setInterval(fetch_status, 1000);
		fetch_status();
	}
</script>
<div class="wrapper">
	<img src='/video_feed' class='video-frame'/>

	<div class="h-group">
		<button class="calibracao" disabled>Iniciar Calibracao</button>
		<button class="iniciar-disparo" disabled>Iniciar Disparo</button>
		<button class="parar-disparo" disabled>Parar Disparo</button>

		<div class="spacer"></div>

		<button class="iniciar-download" disabled>Iniciar Download</button>
		<button class="modo-tempo" disabled>Modo Tempo</button>
		<button class="modo-autonomo" disabled>Modo Autonomo</button>
	</div>

	<div class="v-group">
		<div>Monitoramento</div>
		<div class="status rpi5 err">
			RPi 5
		</div>
		<div class="status rpi0 err">RPi Zero</div>
		<div class="status camera err">Picam</div>
		<div class="status imu err">IMU</div>
	</div>
</div>
</body>
</html>
