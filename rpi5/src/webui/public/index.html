<html lang="pt">
<head>
	<style>
		.wrapper {
			display: grid;
			grid-template-columns: 640px 48px;
			grid-template-rows: 480px 48px;
			grid-gap: 4px;
			font-family: sans;
		}

		.wrapper > .video-frame {
			width: 640px;
			height: 480px;
			grid-area: 1 / 1 / 2 / 2;
		}

		.wrapper > .h-group {
			grid-row: 2;

			display: grid;
			grid-template-columns: repeat(12, 48px);
			grid-template-rows: repeat(12, 48px);
			grid-auto-flow: row;
			grid-gap: 4px;
		}

		.wrapper > .v-group {
			grid-column: 2;

			display: grid;
			grid-template-columns: repeat(12, 144px);
			grid-template-rows: repeat(12, 48px);
			grid-auto-flow: column;
			grid-gap: 4px;
		}

		button {
			grid-column: span 2;
		}

		.status > div {
			display: flex;
			justify-content: center;
			align-items: center;
			text-align: center;
		}

		.status > div.rpi5 {
			grid-row: span 2;
		}

		.ok {
			background-color: #009933;
			color: white;
		}

		.err {
			background-color: #cc0000;
			color: white;
		}
	</style>
	<title>Virtual Encoder</title>
</head>
<body>
<script>
	window.onload = () => {
		const btns = {
			calibracao: document.querySelector('button.calibracao'),
			iniciar_disparo: document.querySelector('button.iniciar-disparo'),
			parar_disparo: document.querySelector('button.parar-disparo'),
			modo_tempo: document.querySelector('button.modo-tempo'),
			modo_autonomo: document.querySelector('button.modo-autonomo'),
			modo_estimativa: document.querySelector('button.modo-estimativa'),
		};

		const status_watcher = {
			rpi5: document.querySelector('.status > .rpi5'),
			rpiZero: document.querySelector('.status > .rpiZero'),
			camera: document.querySelector('.status > .camera'),
			imu: document.querySelector('.status > .imu'),
		};

		async function next_estado(event) {
			event.target.disabled = true;

			const method = 'POST';
			await fetch('/next_estado', { method });
		}

		btns.calibracao.addEventListener('click', next_estado);
		btns.iniciar_disparo.addEventListener('click', next_estado);
		btns.parar_disparo.addEventListener('click', next_estado);

		function update_classname(div, stat) {
			if (stat) div.className = div.className.replace('err', 'ok')
			else div.className = div.className.replace('ok', 'err')
		}

		function update_status(status) {
			update_classname(status_watcher.rpi5, status.rpi5);
			update_classname(status_watcher.rpiZero, status.rpiZero);
			update_classname(status_watcher.camera, status.camera);
			update_classname(status_watcher.imu, status.imu);

			status_watcher.rpi5.innerText = `RPi 5\n\n\nModo ${status.modo}\n\n\nEstado ${status.estado}`

			if (status.modo === 'Tempo') {
				btns.calibracao.disabled = status.estado !== 'Set';
				btns.iniciar_disparo.disabled = status.estado !== 'Ready';
				btns.parar_disparo.disabled = status.estado !== 'Disparo';
			}
		}

		setInterval(async () => {
			const headers = {
				'Accept': 'application/json',
				'Keep-Alive': 'timeout=5, max=-1'
			};
			const method = 'GET';
			const keepalive = true;
			const res = await fetch('/status', {headers, keepalive, method});
			const status = await res.json();

			update_status(status)
		}, 1000);
	}
</script>
<div class="wrapper">
	<img src='/video_feed' class='video-frame'/>

	<div class="h-group">
		<button class="calibracao" disabled>Iniciar Calibracao</button>
		<button class="iniciar-disparo" disabled>Iniciar Disparo</button>
		<button class="parar-disparo" disabled>Parar Disparo</button>

		<button class="modo-tempo" disabled>Modo Tempo</button>
		<button class="modo-autonomo" disabled>Modo Autonomo</button>
		<button class="modo-estimativa" disabled>Modo Estimativa</button>
	</div>

	<div class="status v-group">
		<div class="rpi5 err">
			RPi 5
		</div>
		<div class="rpiZero err">RPi Zero</div>
		<div class="camera err">Picam</div>
		<div class="imu err">IMU</div>
	</div>
</div>
</body>
</html>
